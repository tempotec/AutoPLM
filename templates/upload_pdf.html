{% extends "base.html" %}

{% block title %}Upload PDF - Fichas Técnicas{% endblock %}

{% block content %}
<div class="row mt-4">
    <div class="col-12">
        <h2><i class="fas fa-upload me-2"></i>Upload de Ficha Técnica</h2>
        <hr>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    
                    <div class="upload-area mb-4">
                        <i class="fas fa-file-upload fa-3x text-muted mb-3"></i>
                        <h5>Selecione sua ficha técnica em PDF ou Imagem</h5>
                        <p class="text-muted">Arraste e solte o arquivo aqui ou clique para selecionar</p>
                        <p class="text-muted small"><strong>Formatos aceitos:</strong> PDF, JPG, PNG</p>
                        {{ form.pdf_file(class="form-control", style="display: none;", id="pdf-input", accept=".pdf,.jpg,.jpeg,.png") }}
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('pdf-input').click()">
                            <i class="fas fa-folder-open me-1"></i>Escolher Arquivo
                        </button>
                        
                        {% if form.pdf_file.errors %}
                            <div class="text-danger mt-2">
                                {% for error in form.pdf_file.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div id="file-info" class="alert alert-info" style="display: none;">
                        <i id="file-icon" class="fas fa-file text-primary me-2"></i>
                        <span id="file-name"></span>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Processamento Automático:</strong> Após o upload, o sistema irá extrair automaticamente as seguintes informações:
                        <ul class="mb-0 mt-2">
                            <li>Identificação da Peça (REF, Descrição, Coleção, etc.)</li>
                            <li>Informações Comerciais (Preço, Cronograma)</li>
                            <li>Prazos e Entregas</li>
                            <li>Equipe Envolvida</li>
                            <li>Matéria-Prima e Aviamentos</li>
                            <li>Especificações Técnicas de Modelagem</li>
                            <li>Design e Estilo</li>
                        </ul>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Voltar
                        </a>
                        {{ form.submit(class="btn btn-primary", id="submit-btn") }}
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="loading-indicator" class="alert alert-info mt-3" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-primary me-3" role="status">
                                <span class="visually-hidden">Processando...</span>
                            </div>
                            <div>
                                <strong><i class="fas fa-cog fa-spin me-2"></i>Processando arquivo...</strong>
                                <p class="mb-0 mt-1">Extraindo dados da ficha técnica e analisando imagens. Isso pode levar alguns segundos.</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Show loading indicator on form submit
document.querySelector('form').addEventListener('submit', function(e) {
    const fileInput = document.getElementById('pdf-input');
    if (fileInput.files.length > 0) {
        document.getElementById('loading-indicator').style.display = 'block';
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processando...';
    }
});

function updateFileDisplay(file) {
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const fileIcon = document.getElementById('file-icon');
    
    fileName.textContent = file.name;
    
    // Update icon based on file type
    if (file.type === 'application/pdf') {
        fileIcon.className = 'fas fa-file-pdf text-danger me-2';
    } else if (file.type.startsWith('image/')) {
        fileIcon.className = 'fas fa-file-image text-success me-2';
    } else {
        fileIcon.className = 'fas fa-file text-primary me-2';
    }
    
    fileInfo.style.display = 'block';
}

document.getElementById('pdf-input').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        updateFileDisplay(e.target.files[0]);
    } else {
        document.getElementById('file-info').style.display = 'none';
    }
});

// Drag and drop functionality
const uploadArea = document.querySelector('.upload-area');
const fileInput = document.getElementById('pdf-input');

uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#007bff';
    uploadArea.style.backgroundColor = '#f8f9ff';
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#ccc';
    uploadArea.style.backgroundColor = '#f8f9fa';
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.style.borderColor = '#ccc';
    uploadArea.style.backgroundColor = '#f8f9fa';
    
    const files = e.dataTransfer.files;
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
    
    if (files.length > 0 && allowedTypes.includes(files[0].type)) {
        fileInput.files = files;
        updateFileDisplay(files[0]);
    }
});
</script>
{% endblock %}